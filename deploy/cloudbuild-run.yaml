steps:
# 1. Update/Get Credentials
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['cluster-info']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=gmm-benchmark-v2-cluster'

# 1.5. Cleanup Old Resources
- name: 'gcr.io/cloud-builders/kubectl'
  entrypoint: 'bash'
  args: ['-c', 'kubectl delete job gmm-benchmark-v2 --ignore-not-found=true && kubectl delete statefulset gmm-shards --ignore-not-found=true']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=gmm-benchmark-v2-cluster'

# 2. Apply Job
- name: 'gcr.io/cloud-builders/kubectl'
  args: ['apply', '-f', 'deploy/k8s-v2.yaml']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=gmm-benchmark-v2-cluster'

# 3. Wait for Pod to start
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args: ['-c', 'sleep 30']

# 4. Stream Logs
# We use a script to find the pod and log it.
- name: 'gcr.io/cloud-builders/kubectl'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    echo "Waiting for job to run..."
    kubectl wait --for=condition=ready pod -l job-name=gmm-benchmark-v2 --timeout=600s
    echo "Streaming logs..."
    kubectl logs -l job-name=gmm-benchmark-v2 -f
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
  - 'CLOUDSDK_CONTAINER_CLUSTER=gmm-benchmark-v2-cluster'
